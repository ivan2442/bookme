<?php

namespace App\Http\Controllers;

use App\Models\Appointment;
use App\Models\Profile;
use App\Models\Service;
use Carbon\Carbon;
use Illuminate\Http\Request;
use Illuminate\View\View;

class OwnerDashboardController extends Controller
{
    public function index(Request $request): View
    {
        $user = $request->user();
        $profiles = Profile::where('owner_id', $user->id)->pluck('id');

        $now = Carbon::now();
        $monthStart = $now->copy()->startOfMonth();

        $appointmentsQuery = Appointment::with(['profile', 'service', 'employee'])
            ->whereIn('profile_id', $profiles);

        $stats = [
            'appointments_today' => (clone $appointmentsQuery)->whereDate('start_at', $now)->count(),
            'appointments_month' => (clone $appointmentsQuery)->whereBetween('start_at', [$monthStart, $now])->count(),
            'revenue_month' => (clone $appointmentsQuery)->whereBetween('start_at', [$monthStart, $now])->sum('price'),
            'services' => Service::whereIn('profile_id', $profiles)->count(),
        ];

        $upcoming = (clone $appointmentsQuery)->orderBy('start_at')->limit(5)->get();

        return view('owner.dashboard', compact('stats', 'upcoming'));
    }
}
